<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— äººæœº3Dåœ°å›¾ - å›½å†…åœ°å›¾æº</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.107/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        body { margin: 0; padding: 0; overflow: hidden; }
        #cesiumContainer { width: 100vw; height: 100vh; }
        #controls {
            position: absolute; top: 20px; left: 20px; z-index: 1000;
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.2); max-width: 300px;
        }
        button { display: block; margin: 8px 0; padding: 10px; width: 100%; }
    </style>
</head>
<body>
    <div id="cesiumContainer"></div>
    <div id="controls">
        <h3>æ— äººæœºé£è¡Œè§„åˆ’</h3>
        <button onclick="flyToArea()">âœˆï¸ é£è‡³ä¹é¾™æ¹¾åŒºåŸŸ</button>
        <button onclick="toggleBasemap()">ğŸ—ºï¸ åˆ‡æ¢åœ°å›¾æº</button>
        <button onclick="addBuildings()">ğŸ¢ æ·»åŠ å»ºç­‘</button>
        <button onclick="addTowers()">âš¡ æ·»åŠ è¾“ç”µå¡”</button>
        <div id="status">çŠ¶æ€: åˆå§‹åŒ–...</div>
    </div>

    <script>
        // å¯ç”¨çš„åœ°å›¾æºåˆ—è¡¨ï¼ˆåŒ…å«å›½å†…å¯è®¿é—®çš„æºï¼‰
        const mapProviders = [
            {
                name: "é«˜å¾·åœ°å›¾",
                provider: new Cesium.UrlTemplateImageryProvider({
                    url: "https://webst0{1-4}.is.autonavi.com/appmaptile?style=6&x={x}&y={y}&z={z}",
                    credit: "Â© é«˜å¾·åœ°å›¾"
                })
            },
            {
                name: "è…¾è®¯åœ°å›¾",
                provider: new Cesium.UrlTemplateImageryProvider({
                    url: "https://rt0.map.gtimg.com/realtimerender?z={z}&x={x}&y={y}&type=vector&style=0",
                    credit: "Â© è…¾è®¯åœ°å›¾"
                })
            },
            {
                name: "å¤©åœ°å›¾",
                provider: new Cesium.WebMapTileServiceImageryProvider({
                    url: "https://t0.tianditu.gov.cn/img_w/wmts?tk=æ‚¨çš„å¯†é’¥",
                    layer: "img",
                    style: "default",
                    format: "tiles",
                    tileMatrixSetID: "w",
                    credit: "Â© å›½å®¶åŸºç¡€åœ°ç†ä¿¡æ¯ä¸­å¿ƒ"
                })
            },
            {
                name: "ArcGISä¸–ç•Œåœ°å›¾",
                provider: new Cesium.ArcGisMapServerImageryProvider({
                    url: "https://services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer"
                })
            },
            {
                name: "OpenStreetMap",
                provider: new Cesium.OpenStreetMapImageryProvider({
                    url: "https://tile.openstreetmap.org/"
                })
            },
            {
                name: "æ— åº•å›¾",
                provider: new Cesium.SingleTileImageryProvider({
                    url: "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",
                    rectangle: Cesium.Rectangle.MAX_VALUE
                })
            }
        ];

        // åˆå§‹åŒ–Cesiumï¼ˆå…ˆä½¿ç”¨æ— åº•å›¾æ¨¡å¼ç¡®ä¿æ˜¾ç¤ºï¼‰
        const viewer = new Cesium.Viewer('cesiumContainer', {
            imageryProvider: mapProviders[5].provider, // ä»æ— åº•å›¾å¼€å§‹
            baseLayerPicker: true, // å¯ç”¨åº•å›¾é€‰æ‹©å™¨
            terrainProvider: undefined, // å…ˆå…³é—­åœ°å½¢ï¼Œå‡å°‘åŠ è½½é—®é¢˜
            animation: false,
            timeline: false,
            geocoder: false,
            homeButton: true,
            sceneModePicker: true,
            navigationHelpButton: false,
            fullscreenButton: true
        });

        // æ·»åŠ åº•å›¾é€‰æ‹©å™¨åˆ°æ§åˆ¶é¢æ¿
        let currentMapIndex = 5; // ä»æ— åº•å›¾å¼€å§‹
        
        function toggleBasemap() {
            currentMapIndex = (currentMapIndex + 1) % mapProviders.length;
            const provider = mapProviders[currentMapIndex];
            
            try {
                viewer.imageryLayers.removeAll();
                viewer.imageryLayers.addImageryProvider(provider.provider);
                document.getElementById('status').textContent = `å·²åˆ‡æ¢è‡³: ${provider.name}`;
                console.log(`åˆ‡æ¢åˆ°: ${provider.name}`);
            } catch (error) {
                console.error("åˆ‡æ¢åœ°å›¾å¤±è´¥:", error);
                document.getElementById('status').textContent = `åˆ‡æ¢å¤±è´¥: ${provider.name}`;
            }
        }

        // çŠ¶æ€æ˜¾ç¤º
        const status = document.getElementById('status');
        
        // ç›‘æ§åœ°å›¾åŠ è½½
        viewer.scene.globe.tileLoadProgressEvent.addEventListener((remaining) => {
            status.textContent = `åŠ è½½ç“¦ç‰‡: ${remaining} å‰©ä½™`;
        });
        
        viewer.scene.globe.tileLoadProgressEvent.addEventListener(() => {
            if (viewer.scene.globe.tilesLoaded === 0) {
                status.textContent = "åœ°å›¾åŠ è½½å®Œæˆ";
            }
        });

        // æ·»åŠ æ“ä½œåŒºåŸŸ
        const operationArea = viewer.entities.add({
            name: 'ä¹é¾™æ¹¾æ— äººæœºæ“ä½œåŒº',
            polygon: {
                hierarchy: Cesium.Cartesian3.fromDegreesArray([
                    114.13097, 22.38504,
                    114.14586, 22.38504,
                    114.14586, 22.33912,
                    114.13097, 22.33912
                ]),
                material: Cesium.Color.GREEN.withAlpha(0.3),
                outline: true,
                outlineColor: Cesium.Color.GREEN,
                outlineWidth: 3,
                height: 0,
                extrudedHeight: 100
            }
        });

        // æ·»åŠ æ¨¡æ‹Ÿå»ºç­‘
        const buildings = [];
        function addBuildings() {
            // å…ˆæ¸…é™¤ç°æœ‰å»ºç­‘
            buildings.forEach(b => viewer.entities.remove(b));
            buildings.length = 0;
            
            for (let i = 0; i < 30; i++) {
                const lon = 114.135 + (Math.random() - 0.5) * 0.01;
                const lat = 22.362 + (Math.random() - 0.5) * 0.01;
                const building = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(lon, lat),
                    box: {
                        dimensions: new Cesium.Cartesian3(
                            30 + Math.random() * 30,
                            30 + Math.random() * 30,
                            30 + Math.random() * 100
                        ),
                        material: Cesium.Color.fromRandom({
                            red: 0.6,
                            green: 0.6,
                            blue: 0.8,
                            alpha: 0.9
                        }),
                        outline: true,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 1
                    },
                    name: `å»ºç­‘ ${i+1}`
                });
                buildings.push(building);
            }
            status.textContent = `å·²æ·»åŠ  ${buildings.length} ä¸ªå»ºç­‘`;
        }

        // æ·»åŠ è¾“ç”µå¡”
        const towers = [];
        function addTowers() {
            towers.forEach(t => viewer.entities.remove(t));
            towers.length = 0;
            
            const towerPositions = [
                {lon: 114.135, lat: 22.375, height: 75, name: "ä¸»è¾“ç”µå¡”A"},
                {lon: 114.140, lat: 22.370, height: 65, name: "ä¸»è¾“ç”µå¡”B"},
                {lon: 114.138, lat: 22.365, height: 85, name: "é«˜å‹å¡”"},
                {lon: 114.142, lat: 22.360, height: 70, name: "å˜ç”µå¡”"},
                {lon: 114.132, lat: 22.355, height: 60, name: "åˆ†é…å¡”"},
                {lon: 114.137, lat: 22.345, height: 55, name: "æ¬¡è¦å¡”"}
            ];
            
            towerPositions.forEach(tower => {
                const t = viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(tower.lon, tower.lat),
                    cylinder: {
                        length: tower.height,
                        topRadius: 2,
                        bottomRadius: 4,
                        material: Cesium.Color.RED.withAlpha(0.8),
                        outline: true,
                        outlineColor: Cesium.Color.DARKRED,
                        outlineWidth: 2
                    },
                    label: {
                        text: tower.name,
                        font: '14px "Microsoft YaHei"',
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -25)
                    }
                });
                towers.push(t);
            });
            status.textContent = `å·²æ·»åŠ  ${towers.length} ä¸ªè¾“ç”µå¡”`;
        }

        // é£è‡³æ“ä½œåŒºåŸŸ
        function flyToArea() {
            viewer.flyTo(operationArea, {
                duration: 2,
                offset: new Cesium.HeadingPitchRange(0, -0.8, 2000)
            });
            status.textContent = "å·²é£è‡³ä¹é¾™æ¹¾æ“ä½œåŒº";
        }

        // åˆå§‹è®¾ç½®
        viewer.camera.setView({
            destination: Cesium.Cartesian3.fromDegrees(114.138, 22.362, 1500),
            orientation: {
                heading: Cesium.Math.toRadians(0),
                pitch: Cesium.Math.toRadians(-60),
                roll: 0.0
            }
        });

        // æ‰‹åŠ¨è§¦å‘ä¸€æ¬¡åœ°å›¾åˆ‡æ¢ï¼ˆå°è¯•åŠ è½½ä¸€ä¸ªåœ°å›¾æºï¼‰
        setTimeout(() => {
            toggleBasemap(); // å°è¯•ç¬¬ä¸€ä¸ªåœ°å›¾æº
            addBuildings();
            addTowers();
        }, 1000);

        // é”™è¯¯å¤„ç†
        viewer.scene.renderError.addEventListener((error) => {
            console.error("æ¸²æŸ“é”™è¯¯:", error);
            status.textContent = "åœ°å›¾åŠ è½½é”™è¯¯ï¼Œå°è¯•åˆ‡æ¢åœ°å›¾æº";
        });
    </script>
</body>

</html>
